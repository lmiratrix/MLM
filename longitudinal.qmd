---
title: "A flexible longitudinal model"
author: "Luke Miratrix"
editor: 
  markdown: 
    wrap: sentence
editor_options: 
  chunk_output_type: console
---

```{r setup_long, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(lme4)

options( digits=3 )
knitr::opts_chunk$set( fig.height=3 )

theme_set(theme_minimal())
nyswide <- read_csv("data/nyswide.csv")

nys1 <- nyswide |> 
  pivot_longer(ATTIT.11:EXPO.15, names_to = "score") |> 
  mutate(outcome = word(score, 1, 1, sep = "\\."),
         age = as.numeric(word(score, 2, 2, sep = "\\.")),
         age_fac = factor(age)) |> 
  select(-score) |> 
  pivot_wider(names_from = outcome) |> 
  # drop missing ATTIT values
  drop_na(ATTIT)

```

In this chapter we look at a way of fitting a longitudinal growth model that allows for a nonlinear curve that you do not parameterize.
This is a useful tool for longitudinal data that shows up a lot in the final projects.
That said, this approach only works if you are working with your data in waves.

We will illustrate with the National Youth Survey (NYS) data as described in Raudenbush and Bryk, page 190.
This data comes from a survey in which the same students were asked yearly about their acceptance of 9 "deviant" behaviors (such as smoking marijuana, stealing, etc.).
We analyze the first 5 years of data, and have ATTIT (attitude towards deviance) and `EXPO` ("exposure", based on asking the children how many friends they had who had engaged in each of the "deviant" behaviors).
See @sec-summarizing for more information on the data.

Our modeling approach has two key ideas.
The first is to let each year have its own mean.
The second is to then "tilt" our curves to fit each student as best we can.

## A nonparametric growth model

For the first idea, we make each age a factor, and then fit our model:

```{r,  message=FALSE}
M0 = lmer( ATTIT ~ 0 + age_fac + (1|ID), data=nys1 )
arm::display( M0 )
```

Note how each wave (here age) has its own mean across our coefficients.

We can then plot our population average trajectory:

```{r}
newdata <- nys1 %>%
  dplyr::select( age_fac ) %>%
  unique()
newdata$ID = -1
newdata$ATTIT <- predict(M0, newdata=newdata, re.form=NA)

ggplot(newdata, aes(age_fac, ATTIT, group=ID)) +
  geom_line() + 
  geom_point() + 
  labs(title = "Population average trajectory of attitude towards deviance over time",
       x = "Age",
       y ="Attitude towards deviance") 
```

The problem with this model is that it does not allow for individual trajectories for each student.
All the individual kids all grow exactly the same, which might not be in line with what the data would actually show.
We are only allowing for an intercept shift.
We want to extend this model so that each student can have their own growth trajectory; we do this next.

## Adding random slopes

Even though we have fixed effects for growth, we can still let each student have their own random slope for growth rate, which will "tilt" our nonparameteric curve for each student.
We do this by having a random slope on the *continuous* age variable, even though our fixed effects are on the *factor* age variable.
We center age around the beginning of the study, so our random intercepts correspond to ATTIT at age 11.

```{r}
nys1$age_c = nys1$age - 11
M1 = lmer( ATTIT ~ 0 + age_fac + (1+age_c|ID), data=nys1,
           control = lmerControl(optimizer = 'bobyqa') )
arm::display( M1 )
```

We can then plot individual trajectories to see how this model is working.
We first make a set of 20 students to plot:

```{r}
set.seed( 40440 )
smp <- sample( unique( nys1$ID ), 20 )
smp_dat <- nys1 %>% filter( ID %in% smp ) %>%
  complete( ID, age ) %>%
  mutate( age_fac = as.factor( age ),
          age_c = age - 11 )
```

Each student is five rows of data, sometimes with missing values due to the `complete()` method from above:

```{r}
filter( smp_dat, ID == 52 ) %>%
  dplyr::select( ID, age, age_fac, age_c, ATTIT )
```

We next predict the values for each student and plot those predicted values:

```{r, fig.width = 5, fig.height = 4}
smp_dat$pred <- predict(M1, newdata=smp_dat)

# Make a population reference curve
newdata$age = 11:15
newdata$age_c = 0:4
newdata$pred <- predict(M1, newdata=newdata, re.form=NA)

ggplot(smp_dat, aes(age, pred)) +
  geom_line( aes( group=ID ), alpha=0.5) + 
  labs(title = "Individual trajectories",
       x = "Age",
       y ="Attitude towards deviance") +
  geom_line( data = newdata, col="red", linewidth=1 )
```

Note how all our students have the same *shape* of our overall trajectory, but some are slightly steeper and some more shallow.
This allows us to have a shared shape that we can shift (random intercept) and tilt (random slope) to fit the actual data.

Compare our trajectories to the measured values:

```{r, warning=FALSE}
newdata$ID = NULL
ggplot(smp_dat, aes(age, ATTIT)) +
  facet_wrap( ~ ID ) +
  geom_point() + 
  geom_line( aes( y = pred ), col="blue" ) +
  labs(title = "Comparing latent curves to observed values",
       x = "Age",
       y ="Attitude towards deviance") +
    geom_line( data = newdata, col="red", lty=2 )
```

We can see how the latent curves are trying to get close to the observed data for each student.
Our fit seems reasonable, but not perfect.

## And the math?

Writing the math can be tricky for this model.
We do not have an intercept anymore, but instead have a different fixed effect for each time point.

We could write our level 1 model with those individual fixed effects for each time point, and a linear growth on top of it:

*Level 1:* We have for individual $i$ at time $t$: 

$$ Y_{ti} = \beta_{t} + \beta_{0i} + \beta_{1i} ( age_{ti} - L ) + \epsilon_{ti} $$
The $\beta_{t}$ here are the fixed effects for each time point (age).

*Level 2:* We can then write for level 2 (assuming we have some individual level covariate $X_i$):

$$
\begin{align*}
\beta_{0i} &= \gamma_{01} X_i + u_{0i} \\
\beta_{1i} &= \gamma_{11} X_i + u_{1i}
\end{align*}
$$
Note we do not have any $\gamma_{00}$ or $\gamma_{10}$---this is because our population curve is captured by the $\beta_t, t = 1, \ldots, 5$.
In other words, the growth curve is relative growth around the fixed effects, and is implicitly zero-centered.


<!--As an alternate, we could also try to write the model as:

$$ Y_{ti} = \beta_{ti} + \epsilon_{ti} $$
Now we are having fixed effects for each time point, but we are allowing them to vary by student, hence the additional $i$ subscript.
We then need to specify what the $\beta_{ti}$, for $t = 1, \ldots, 5$, are.

*Level 2:* We can then write for level 2 (assuming we have some individual level covariate $X_i$):
$$
\begin{align*}
\beta_{0i} &= \gamma_{00} + u_{0i} \\
\beta_{1i} &= \gamma_{10} + u_{0i} + u_{1i} \\
\beta_{2i} &= \gamma_{20} + \gamma_{21} X
\\
\beta_{3i} &= \gamma_{30} + \gamma_{31} X

 -->

## Conclusion

Hopefully this tool of a nonparameteric curve is useful for examining how different waves of data may be different from one another.
For example, if COVID happened in the middle of your study, you might expect a big shift in the data.
This model allows you to model that shift while still allowing for different individual growth trajectories over time.
