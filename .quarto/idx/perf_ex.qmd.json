{"title":"Example of a three-level model of clustered data","markdown":{"yaml":{"title":"Example of a three-level model of clustered data","author":"Luke Miratrix","editor":{"markdown":{"wrap":"sentence"}}},"headingText":"Load the data","containsRefs":false,"markdown":"\n\nThis will illustrate fitting a three level model (with clusters inside of clusters) and extracting the various components from it.\nThis is a rough document, but hopefully will be useful.\n\n```{r loadlibs, echo=FALSE, message=FALSE, warning=FALSE}\nlibrary(tidyverse)\nlibrary(lme4)\nlibrary(foreign)\nlibrary(ggplot2)\nlibrary( arm )\n```\n\n\nWe first load the data.\nThis is a dataset extensively discussed in Rabe-Hesketh and Skrondal.\nI am replicating the model they propose in chapter 8.4.\nThis story is as follows: the data set is a collection of measurements for a test-retest of two peak expiratory flow measurement devices (in English, patients were told to exhale into a device to measure their lung capacity, and they did so twice for two different measurement devices).\nWe want to understand whether the types of meter are different, and also understand variation in subjects lung capacities, and variation in the measurement error of the meters.\n\nIn the following we load the data and look at the first few lines.\nWe see that each subject had two measurements from the standard and the mini Wright flow meter.\n\n```{r}\npefr = read.dta( \"data/pefr.dta\" )\n\nhead( pefr )\n```\n\nWe are going to view this as three-level data.\nWe have multiple measurements nested inside device type nested inside subject.\nWe might imagine that different subjects have different lung capacities.\nWe also might imagine that different subjects are going to have different biases when using the two different meters.\nThe two observations for each meter allows us to understand the variability of measurements for a single meter for a given subject, and looking at how these vary across subjects allows us to understand how much the biases move across individuals.\n\n## Reshape the data (Optional section)\n\nThis section illustrates some advanced reshaping techniques.\nIn particular we reshape the data twice to deal with the time and the device as different levels.\n\nHere we go:\n\n```{r}\ndat = reshape( pefr, direction=\"long\", idvar = \"id\", \n               varying=list( c(\"wp1\",\"wm1\"), c(\"wp2\",\"wm2\") ),\n               times=c(\"wp\",\"wm\"),\n               timevar=\"device\",\n               v.names=c(\"time1\",\"time2\") )\n```\n\nLet's see what we got:\n\n```{r}\nhead( dat )\nsubset( dat, id==1 )\n```\n\nThe second line above shows us our first person now as two new lines, one for each device.\nWe see the measurements correspond to the first row of the original `pefr` data.\n\nNow we have a row for each person for each device.\nNext we unstack the time (and then look at what we got):\n\n```{r}\ndat = reshape( dat, direction=\"long\", idvar=c(\"id\",\"device\"),\n               varying=list( c(\"time1\",\"time2\") ),\n               v.names=c(\"flow\") )\nhead( dat )\n```\n\nWe look at our second person to see if the measurements have the appropriate labels.\nThey do.\n\n```{r}\nsubset( dat, id==2 )\nsubset( pefr, id==2 )\n```\n\nAnother sanity check:\n\n```{r}\ntable( dat$id )\n```\n\nWe have four measurements, still, for each person.\n\nWhen reshaping data, one typically has to fiddle with all of the commands and check the results a few times to get it right.\n\n## Plot the data\n\nWe can look at the data.\nThe following illustrates getting different colors and symbols depending on covariate information:\n\n```{r}\ndat$id = as.factor( dat$id )\ndat$device = as.factor( dat$device )\ndat$time = as.factor( dat$time )\nggplot( data=dat, aes( x=id, y=flow, col=device, pch=time ) ) + \n    geom_jitter( width=0.2, height=0 )\n```\n\n## The mathematical model\n\n*Level 1:* We have for individual $i$ using machine $j$ at time $t$: \\[ Y\\_{ijt} = \\beta*{0ij} +\\* \\beta{1} t + \\epsilon\\_{ijt} \\] The $\\beta_{1}$ allows for a time effect of the second measurement being systematically lower or higher than the first.\nWe pool this across all subjects and machines.\n\n*Level 2:* Our machine-level intercepts for each subject are \\[ \\beta*{0ij} =\\* \\gamma{0i} + \\gamma*1 D_j + u\\*{ij} \\] with $D_j = 1\\{ j = wp \\}$ being an indicator (dummy variable) for the second machine.\nThe $\\gamma_1$ allows a systematic bias for the two machines (so the wp machine could tend to give larger readings than the wm machine, for example).\nOverall, the above says each machine expected reading varies around the subject's lung capacity, but that these expected readings will vary around the subjects true capacity by the $u_{ij}$.\nActual readings for subject $i$ on machine $j$ will hover around $\\beta_{ij}$ if we had the subject test over and over, according to our model (not including fatigue captured by the time coefficient).\n\n*Level 3:* Finally our subject intercepts are \\[ \\gamma*{0i} =\\* \\mu + w{i} .\n\\] The overall population lung capacity is $\\mu$.\nSubjects have larger or smaller lung capacity depending on their $w_{i}$.\n\nThe $u_{ij}$ and $w_i$ are each normally distributed, and independent from each other.\n\nThe $w_i$ are how the subjects vary (i.e., their different lung capacities).\nThe $u_{ij}$ are the individual biases of a machine for a given subject.\nLooking at our plot, we see that subjects vary a lot, and machines vary sometimes within a subject (the centers of the pairs of colored points tend to be close, but not always), and the residual variance tends to be small (colored points are close together).\n\n## Fit the model\n\n```{r}\nlibrary( lme4 )\nM1 = lmer( flow ~ device + time + (1|id) + (1|device:id), data=dat )\ndisplay( M1 )\n```\n\nNow let's connect some pieces:\n\n-   The main effects estimate $\\mu = 455.46$ and $\\gamma_1 = -6.03$ and $\\beta_1 = -1.03$.\n-   The z-score of $z = -6.03 / 8.05 < 1$ means there is no evidence of systematic bias of one machine compared to the other.\n-   The estimated standard deviation of actual lung capacity is 112.\n-   The estimated standard deviation of how two different machines will measure the same person is $19.72$. Different machines will tend to give different average measurements for the same subject.\n-   The estimated standard deviation of how much a repeated measurement of the same machine on the same person will vary is 18. The machines are relatively precise, given the variation in the population.\n-   The amount of variance explained by lung variation is $112^2 / (19.72^2 + 111.99^2 + 18.01^2) = `r 112^2 / (19.72^2 + 111.99^2 + 18.01^2)`$, i.e., most of it.\n\n## Appendix (Optional): base plot package\n\nHere is how to build the plot without ggplot:\n\n```{r}\nplot( flow ~ as.numeric(id), data=dat, pch=ifelse( time==1, 21, 22 ),\n      col=ifelse( device==\"wp\", \"red\", \"green\" ) )\nlegend( \"bottomleft\", legend=c(\"WP-1\", \"WP-2\",\"WM-1\", \"WM-2\"),\n        pch=c(21,22,21,22),\n        col=c(\"red\",\"red\",\"green\",\"green\") )\n```\n","srcMarkdownNoYaml":"\n\nThis will illustrate fitting a three level model (with clusters inside of clusters) and extracting the various components from it.\nThis is a rough document, but hopefully will be useful.\n\n```{r loadlibs, echo=FALSE, message=FALSE, warning=FALSE}\nlibrary(tidyverse)\nlibrary(lme4)\nlibrary(foreign)\nlibrary(ggplot2)\nlibrary( arm )\n```\n\n## Load the data\n\nWe first load the data.\nThis is a dataset extensively discussed in Rabe-Hesketh and Skrondal.\nI am replicating the model they propose in chapter 8.4.\nThis story is as follows: the data set is a collection of measurements for a test-retest of two peak expiratory flow measurement devices (in English, patients were told to exhale into a device to measure their lung capacity, and they did so twice for two different measurement devices).\nWe want to understand whether the types of meter are different, and also understand variation in subjects lung capacities, and variation in the measurement error of the meters.\n\nIn the following we load the data and look at the first few lines.\nWe see that each subject had two measurements from the standard and the mini Wright flow meter.\n\n```{r}\npefr = read.dta( \"data/pefr.dta\" )\n\nhead( pefr )\n```\n\nWe are going to view this as three-level data.\nWe have multiple measurements nested inside device type nested inside subject.\nWe might imagine that different subjects have different lung capacities.\nWe also might imagine that different subjects are going to have different biases when using the two different meters.\nThe two observations for each meter allows us to understand the variability of measurements for a single meter for a given subject, and looking at how these vary across subjects allows us to understand how much the biases move across individuals.\n\n## Reshape the data (Optional section)\n\nThis section illustrates some advanced reshaping techniques.\nIn particular we reshape the data twice to deal with the time and the device as different levels.\n\nHere we go:\n\n```{r}\ndat = reshape( pefr, direction=\"long\", idvar = \"id\", \n               varying=list( c(\"wp1\",\"wm1\"), c(\"wp2\",\"wm2\") ),\n               times=c(\"wp\",\"wm\"),\n               timevar=\"device\",\n               v.names=c(\"time1\",\"time2\") )\n```\n\nLet's see what we got:\n\n```{r}\nhead( dat )\nsubset( dat, id==1 )\n```\n\nThe second line above shows us our first person now as two new lines, one for each device.\nWe see the measurements correspond to the first row of the original `pefr` data.\n\nNow we have a row for each person for each device.\nNext we unstack the time (and then look at what we got):\n\n```{r}\ndat = reshape( dat, direction=\"long\", idvar=c(\"id\",\"device\"),\n               varying=list( c(\"time1\",\"time2\") ),\n               v.names=c(\"flow\") )\nhead( dat )\n```\n\nWe look at our second person to see if the measurements have the appropriate labels.\nThey do.\n\n```{r}\nsubset( dat, id==2 )\nsubset( pefr, id==2 )\n```\n\nAnother sanity check:\n\n```{r}\ntable( dat$id )\n```\n\nWe have four measurements, still, for each person.\n\nWhen reshaping data, one typically has to fiddle with all of the commands and check the results a few times to get it right.\n\n## Plot the data\n\nWe can look at the data.\nThe following illustrates getting different colors and symbols depending on covariate information:\n\n```{r}\ndat$id = as.factor( dat$id )\ndat$device = as.factor( dat$device )\ndat$time = as.factor( dat$time )\nggplot( data=dat, aes( x=id, y=flow, col=device, pch=time ) ) + \n    geom_jitter( width=0.2, height=0 )\n```\n\n## The mathematical model\n\n*Level 1:* We have for individual $i$ using machine $j$ at time $t$: \\[ Y\\_{ijt} = \\beta*{0ij} +\\* \\beta{1} t + \\epsilon\\_{ijt} \\] The $\\beta_{1}$ allows for a time effect of the second measurement being systematically lower or higher than the first.\nWe pool this across all subjects and machines.\n\n*Level 2:* Our machine-level intercepts for each subject are \\[ \\beta*{0ij} =\\* \\gamma{0i} + \\gamma*1 D_j + u\\*{ij} \\] with $D_j = 1\\{ j = wp \\}$ being an indicator (dummy variable) for the second machine.\nThe $\\gamma_1$ allows a systematic bias for the two machines (so the wp machine could tend to give larger readings than the wm machine, for example).\nOverall, the above says each machine expected reading varies around the subject's lung capacity, but that these expected readings will vary around the subjects true capacity by the $u_{ij}$.\nActual readings for subject $i$ on machine $j$ will hover around $\\beta_{ij}$ if we had the subject test over and over, according to our model (not including fatigue captured by the time coefficient).\n\n*Level 3:* Finally our subject intercepts are \\[ \\gamma*{0i} =\\* \\mu + w{i} .\n\\] The overall population lung capacity is $\\mu$.\nSubjects have larger or smaller lung capacity depending on their $w_{i}$.\n\nThe $u_{ij}$ and $w_i$ are each normally distributed, and independent from each other.\n\nThe $w_i$ are how the subjects vary (i.e., their different lung capacities).\nThe $u_{ij}$ are the individual biases of a machine for a given subject.\nLooking at our plot, we see that subjects vary a lot, and machines vary sometimes within a subject (the centers of the pairs of colored points tend to be close, but not always), and the residual variance tends to be small (colored points are close together).\n\n## Fit the model\n\n```{r}\nlibrary( lme4 )\nM1 = lmer( flow ~ device + time + (1|id) + (1|device:id), data=dat )\ndisplay( M1 )\n```\n\nNow let's connect some pieces:\n\n-   The main effects estimate $\\mu = 455.46$ and $\\gamma_1 = -6.03$ and $\\beta_1 = -1.03$.\n-   The z-score of $z = -6.03 / 8.05 < 1$ means there is no evidence of systematic bias of one machine compared to the other.\n-   The estimated standard deviation of actual lung capacity is 112.\n-   The estimated standard deviation of how two different machines will measure the same person is $19.72$. Different machines will tend to give different average measurements for the same subject.\n-   The estimated standard deviation of how much a repeated measurement of the same machine on the same person will vary is 18. The machines are relatively precise, given the variation in the population.\n-   The amount of variance explained by lung variation is $112^2 / (19.72^2 + 111.99^2 + 18.01^2) = `r 112^2 / (19.72^2 + 111.99^2 + 18.01^2)`$, i.e., most of it.\n\n## Appendix (Optional): base plot package\n\nHere is how to build the plot without ggplot:\n\n```{r}\nplot( flow ~ as.numeric(id), data=dat, pch=ifelse( time==1, 21, 22 ),\n      col=ifelse( device==\"wp\", \"red\", \"green\" ) )\nlegend( \"bottomleft\", legend=c(\"WP-1\", \"WP-2\",\"WM-1\", \"WM-2\"),\n        pch=c(21,22,21,22),\n        col=c(\"red\",\"red\",\"green\",\"green\") )\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","highlight-style":"pygments","output-file":"perf_ex.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.353","bibliography":["references.bib"],"output_dir":"docs","editor":{"markdown":{"wrap":"sentence"}},"theme":"cosmo","code-copy":true,"title":"Example of a three-level model of clustered data","author":"Luke Miratrix"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","highlight-style":"pygments","output-file":"perf_ex.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"output_dir":"docs","editor":{"markdown":{"wrap":"sentence"}},"documentclass":"scrreprt","title":"Example of a three-level model of clustered data","author":"Luke Miratrix"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}