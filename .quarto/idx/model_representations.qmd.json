{"title":"Model Representations","markdown":{"yaml":{"title":"Model Representations","author":"Luke Miratrix","editor":{"markdown":{"wrap":"sentence"}}},"headingText":"The Scenario","containsRefs":false,"markdown":"\n\nThis handout walks through the mathematical representation of two core models: the random intercept model and the random slope model.\nThe goal is to very carefully explain all the different math parts, and show how that translates to a `lmer()` call to R for fitting the model.\n\n\nWe have a collection of schools that we have randomized into treatment and control conditions.\nThe treatment condition is a novel reading program and the control condition is business as usual.\nWe hope that the treatment accomplishes two things: raising reading level overall, and reducing the gap in reading level between \"at-risk\" kids and not at risk kids (we assume we have a at-risk status as a dummy variable, measured for all kids and treatment and control prior to treatment).\n\n## The Two-Level Random Intercept Model\n\nWe will use the \"double-indexing\" that is the most common notation for multilevel models (not the Gelman and Hill bracket ($j[i]$) notation).\nTreatment is at the *school level*: let $Z_j$ be an indicator of whether school $j$ was treated (so a 0/1 variable).\nThen, for student $i$ in school $j$ we have $$\\begin{aligned}\nY_{ij} &= \\alpha_{j} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n\\alpha_{j} &= \\gamma_{0} + \\gamma_{1} Z_{j} + \\gamma_{2} S_{j} + u_{j} \\\\\n\\end{aligned}$$ with $Y_{ij}$ being the reading level of the student, $R_{ij}$ being a dummy variable of student's \"at risk\" status, $X_{ij}$ being an important student demographic variable (e.g., prior reading level), and $S_j$ being a school-level covariate (such as a school quality measure).\n\nThis is the two-level model.\nLevel 1 is the first equation with the distribution on the residuals of $\\epsilon_{ij} \\sim N( 0, \\sigma^2 )$.\nLevel 2 is the second equation with a distribution of random effects of $$u_{j} \\sim N( 0, \\sigma^2_\\alpha ) .$$ The $\\sigma^2_\\alpha$ is the variance of the random intercept.\n\nCall the $\\beta_{0j}$ the random intercept and $u_{j}$ the random effect.\nThe $u_{j}$ is the residual of the level 2 model,.\nIn R, we would say `coef()` for the intercept (including the mean $\\gamma_0$) and `ranef()` for the random effect.\nIn math, `coef()` gives $\\gamma_0 + u_j$ and `ranef()` gives only $u_j$.\nNeither include the $\\gamma_1$ or $\\gamma_2$; these will be separate columns you get from `coef()`.\n\n##### Remarks.\n\nWe have *completely pooled* the coefficient for $R_{ij}$ and $X_{ij}$: we are assuming all the schools have the same relationship between the outcome and these covariates.\n\nThe intercept $\\alpha_{j}$ is the expected (predicted average) outcome of a not-at-risk student with $X_{ij} = 0$.\nDifferent schools have different means.\nIn particular, treatment schools have a mean of $\\gamma_1$ more than control; this is the treatment impact.\n\n### The Reduced Form Model\n\nIf we plug in our 2nd level into the first we get the following: $$\\begin{aligned}\nY_{ij} &= \\beta_{0j} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n&= (\\gamma_{0} + \\gamma_{1} Z_{j} + \\gamma_{2} S_{j} + u_{j}) + \\beta_1 R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n&= \\gamma_{0} + \\gamma_{1} Z_{j} + \\gamma_{2} S_{j} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + (u_{j} + \\epsilon_{ij})\n\\end{aligned}$$ The $u_{0j} + \\epsilon_{ij}$ is our total random error.\nIt is how much our prediction of a new, unknown student, would differ from their actual score if we didn't know the school's random effect.\nThe rest of the model is the mean model or structural portion of the model.\n\nThis is also called the *reduced form*; it is what econometricians work with.\nThey will write the entire residual as $\\varepsilon_{ij}$, however: $$\\begin{aligned}\nY_{ij} &= \\gamma_{0} + \\gamma_{1} Z_{j} + \\gamma_{2} S_{j} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + \\varepsilon_{ij}\n\\end{aligned}$$\n\n##### Remarks.\n\nThe reduced form helps us see our treatment effect more clearly.\nIt is a shift in outcome of $\\gamma_1$ for treated students.\n\nThe $\\gamma_{0}$ is the overall mean reading level for students with $X_{ij}=0$ for not-at-risk students ($R_{ij}=0$) in control schools with $S_j = 0$.\n\nNote how we subscript school-level covariates with only a $j$ vs. individual-level covariates get an $ij$.\nIf you want, you can index everything by $ij$; the fact that $S_{ij}$ will then be the same for all students $i$ in school $j$ is hidden in the data.\nBut it does make it look very much like OLS with a weird error term: $$\nY_{ij} = \\gamma_{0} + \\gamma_{1} Z_{ij} + \\gamma_{2} S_{ij} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + (u_{j} + \\epsilon_{ij})\n$$\n\nFinally, you might call all the different pieces by different letters to indicate whether you care about them or not.\nE.g., $$Y_{ij} = \\mu + \\tau Z_{ij}  + \\beta_1 S_{ij} + \\beta_2 R_{ij} + \\beta_3 X_{ij} + (u_{0j} +  \\epsilon_{ij}) .$$ Here $\\tau$ is our treatment effects of interest.\nThe $\\beta$'s are just adjustments to be ignored.\nThe $\\mu$ is the grand mean (for those not treated, with $S_{ij} = 0$ and $R_{ij} = 0$ and $X_{ij} = 0$).\nPeople often use $\\mu$ for mean and $\\tau$ for treatment.\n\n### Fitting it in lmer\n\nWe fit it as:\n\n```         \n    lmer( Y ~ R + Z + X + S + (1|id), data=dat )\n```\n\n## The Two-Level Random Slopes Model\n\nNow let's get very complex to really unpack notational stuff.\nWe are going to let treatment not only impact the average outcome in schools, but also allow treatment to differentially impact students who are \"at risk\".\nI.e., we are going to have two treatment impacts, one for not at risk, and one for at risk.\nThis is an interaction of risk status and treatment.\n\nFurthermore, we are going to let different schools have different gaps between at risk and not at risk, but allowing a random effect for the at risk coefficient.\n\nUsing our same variables as above, we have, for student $i$ in school $j$ $$\\begin{aligned}\nY_{ij} &= \\beta_{0j} + \\beta_{1j} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n\\beta_{0j} &= \\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + u_{0j} \\\\\n\\beta_{1j} &= \\gamma_{10} + \\gamma_{11} Z_{j} + u_{1j} .\n\\end{aligned}$$\n\nThis is the two-level model.\nLevel 1 is the first equation with the distribution on the residuals of $\\epsilon_{ij} \\sim N( 0, \\sigma^2 )$.\nLevel 2 are the second and third equations, and the distribution of random effects of $$\n\\begin{pmatrix} u_{0j} \\\\\nu_{1j}\n\\end{pmatrix} \\sim  N\n\\begin{bmatrix}\n\\begin{pmatrix}\n0 \\\\\n0\n\\end{pmatrix}\\!\\!,&\n\\begin{pmatrix}\n\\tau_{00} & \\tau_{10} \\\\\n\\tau_{10} & \\tau_{11} \\\\\n\\end{pmatrix}\n\\end{bmatrix}\n$$ The $\\tau_{00}$ is the variance of the random intercept.\n$\\tau_{11}$ is the variance of the random slope.\n$\\tau_{10}$ is the covariance (not correlation) of the random effects.\nTo get the *correlation* of random effects we have $\\rho = \\tau_{10} / \\sqrt{ \\tau_{00} } \\sqrt{ \\tau_{11} }$.\n(Note that $\\tau_{10} = \\tau_{01}$, meaning the covariance of A and B is the same as covariance of B and A, so we just write one of them.)\n\nCall the $\\beta_{0j}$ the random intercept and $\\beta_{1j}$ a random coefficient.\nWe might call them both random coefficients.\nCall the $u_{0j}, u_{1j}$, which are the residuals of the level 2 models, the random effects.\nIn R, we would say `coef()` for the coefficients (including the means) and `ranef()` for the random effects.\n\n### Remarks.\n\nWe have *completely pooled* the coefficient for $X_{ij}$: we are assuming all the schools have the same relationship between the outcome and $X_{ij}$.\nThis is why we have no level 2 equation for $\\beta_{2}$ and we do not index $\\beta_2$ as $\\beta_{2j}$.\n\nThe intercept $\\beta_{0j}$ is the expected (predicted average) outcome of a not-at-risk student with $X_{ij} = 0$.\nDifferent schools have different means.\n\nThe achievement gap of at-risk and not-at-risk students for control schools is measured by $\\gamma_{10}$.\nFor treatment schools it is $\\gamma_{10} + \\gamma_{11}$.\n\nThe $\\gamma_{01}$ is the average treatment effect for not-at-risk students.\nThen $\\gamma_{01} + \\gamma_{11}$ is the average treatment effect for the at-risk students.\nIf we find $\\gamma_{11} \\neq 0$ then the average effects differ for our two types of students, and the change in the achievement gap induced by treatment is measured by $\\gamma_{11}$.\n\nIn this model, the school-level covariate explains overall differences in reading between schools, but does not relate to the size of treatment impact in a school, or relate to the at-risk vs. not-at-risk achievement gap.\n\n### The level 2 covariate matrix.\n\nSometimes people like to write the correlation matrix using other parameterizations.\nE.g., we might see $$\n\\begin{pmatrix} u_{0j} \\\\\nu_{1j}\n\\end{pmatrix} \\sim  N\n\\begin{bmatrix}\n\\begin{pmatrix}\n0 \\\\\n0\n\\end{pmatrix}\\!\\!,&\n\\begin{pmatrix}\n\\sigma^2_\\alpha & \\rho \\sigma_\\alpha \\sigma_R \\\\\n & \\sigma^2_R \\\\\n\\end{pmatrix}\n\\end{bmatrix}\n$$ to indicate the cross-school variation in the intercept ($\\alpha$) and the risk gap ($R$).\nNow we specifically have written our correlation of random effects as $\\rho$.\n\n### The Reduced Form Model\n\nIf we plug in our 2nd level into the first we have to plug in both equations.\nIf we do we get\\...\na mess: $$\\begin{aligned}\nY_{ij} &= \\beta_{0j} + \\beta_{1j} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n&= (\\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + u_{0j}) + (\\gamma_{10} + \\gamma_{11} Z_{j} + u_{1j}) R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n&= \\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + u_{0j} + \\gamma_{10} R_{ij} + \\gamma_{11} Z_{j} R_{ij} + u_{1j} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\ \n&= \\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + \\gamma_{10} R_{ij} + \\gamma_{11} Z_{j} R_{ij} + \\beta_{2} X_{ij} + u_{0j} +  u_{1j} R_{ij} + \\epsilon_{ij} \\\\\n&= \\gamma_{00} + (\\gamma_{01} + \\gamma_{11} R_{ij} ) Z_{j}  + \\gamma_{02} S_{j} + \\gamma_{10} R_{ij} + \\beta_{2} X_{ij} + (u_{0j} +  u_{1j} R_{ij} + \\epsilon_{ij}) \\\\\n\\end{aligned}$$ The $u_{0j} + u_{1j} R_{ij} + \\epsilon_{ij}$ is our total random error.\nIt is how much our prediction of a new, unknown student, would differ from their actual score if we didn't know the school's random effect.\nThe rest of the model is the mean model or structural portion of the model.\n\nThis is our *reduced form*; it is what econometricians work with.\nThey will write the entire residual as $\\varepsilon_{ij}$, however: $$\\begin{aligned}\nY_{ij} &= \\gamma_{00} + (\\gamma_{01} + \\gamma_{11} R_{ij} ) Z_{j}  + \\gamma_{02} S_{j} + \\gamma_{10} R_{ij} + \\beta_{2} X_{ij} + \\varepsilon_{ij} \\\\\n\\end{aligned}$$\n\n##### Remarks.\n\nThe reduced form helps us see our treatment effects and treatment variation across groups more clearly.\nWe can put both terms involving the treatment indicator in parenthesis (final line above) to show how treatment is different by $\\gamma_{11}$ for the at-risk students.\n\nWe also see that the difference in treatment effects between at-risk and not at-risk is an *interaction* between student risk and treatment assignment of the school (note the $Z_j R_{ij}$ term).\n\nThe $\\gamma_{00}$ is the overall mean reading level for students with $X_{ij}=0$ for not-at-risk students in control schools.\nThe $\\gamma_{10}$ is the average difference between at-risk and not-at-risk students in control schools, across all schools.\n\nWe can rearrange our equations above to get $$Y_{ij} = ( \\gamma_{00} + u_{0j}) + (\\gamma_{01} + \\gamma_{11} R_{ij} + u_{1j} ) Z_{j} + \\gamma_{02} S_{j} + \\gamma_{10} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} .$$ This shows the random intercept and random slope all bundled up.\n\nAs with the intercept model, you might call all the different pieces by different letters to indicate whether you care about them or not.\nE.g., $$Y_{ij} = \\mu + \\tau Z_{ij}  + \\beta_1 S_{ij} + \\beta_2 R_{ij} + \\beta_3 X_{ij} + \\tau_{R} Z_{ij} R_{ij}  + (u_{0j} +  u_{1j} R_{ij} + \\epsilon_{ij}) .$$ Here $\\tau$ and $\\tau_R$ are our treatment effects of interest.\nThe $\\beta$'s are just adjustments to be ignored.\nThe $\\mu$ is the grand mean.\nThis model is the same as above, we are just changing names around.\n\n### Fitting it in lmer\n\nWe fit it as:\n\n```         \n    lmer( Y ~ R * Z + X + S + (R|id), data=dat )\n```\n\nTwo other ways of saying the same thing:\n\n```         \n    lmer( Y ~ 1 + R * Z + X + S + (1 + R|id), data=dat )\n```\n\nand\n\n```         \n    lmer( Y ~ 1 + Z + S + R + Z:R + X + (1 + R|id), data=dat )\n```\n\n### Remarks.\n\nSee how the reduced form and `lmer()` align, especially if we write out what R automatically does with `R * Z` (R will expand `R*Z` into `R + Z + R:Z` automatically).\n\n### Another form for the two-level model\n\nThe above is the \"double-subscript\" way of writing a model.\nBy contrast, Gelman and Hill index with a nifty \"bracket notation.\" First, let $j[i]$ indicate the school student $i$ is attending.\nThen we have: $$\\begin{aligned}\nY_{i} &= \\beta_{0j[i]} + \\beta_{1j[i]} R_{i} + \\beta_{2} X_{i} + \\epsilon_{i} \\\\\n\\beta_{0j} &= \\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + u_{0j} \\\\\n\\beta_{1j} &= \\gamma_{10} + \\gamma_{11} Z_{j} + u_{1j},\n\\end{aligned}$$ This is basically identical to the above, but if you are not familiar with the bracketing then things can get messy.\n\nThe advantage of this is we can then imagine each student gets their own unique id, $i$, and then we can query where that student is via $j[i]$.\nThis can be useful when looking at crossed effects models, where units have different random effects for different things (e.g., for a test we might have observation $k$ corresponding to a single answer for a test question, with $i[k]$ being the student who answered it and $q[k]$ being the question item).\n","srcMarkdownNoYaml":"\n\nThis handout walks through the mathematical representation of two core models: the random intercept model and the random slope model.\nThe goal is to very carefully explain all the different math parts, and show how that translates to a `lmer()` call to R for fitting the model.\n\n## The Scenario\n\nWe have a collection of schools that we have randomized into treatment and control conditions.\nThe treatment condition is a novel reading program and the control condition is business as usual.\nWe hope that the treatment accomplishes two things: raising reading level overall, and reducing the gap in reading level between \"at-risk\" kids and not at risk kids (we assume we have a at-risk status as a dummy variable, measured for all kids and treatment and control prior to treatment).\n\n## The Two-Level Random Intercept Model\n\nWe will use the \"double-indexing\" that is the most common notation for multilevel models (not the Gelman and Hill bracket ($j[i]$) notation).\nTreatment is at the *school level*: let $Z_j$ be an indicator of whether school $j$ was treated (so a 0/1 variable).\nThen, for student $i$ in school $j$ we have $$\\begin{aligned}\nY_{ij} &= \\alpha_{j} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n\\alpha_{j} &= \\gamma_{0} + \\gamma_{1} Z_{j} + \\gamma_{2} S_{j} + u_{j} \\\\\n\\end{aligned}$$ with $Y_{ij}$ being the reading level of the student, $R_{ij}$ being a dummy variable of student's \"at risk\" status, $X_{ij}$ being an important student demographic variable (e.g., prior reading level), and $S_j$ being a school-level covariate (such as a school quality measure).\n\nThis is the two-level model.\nLevel 1 is the first equation with the distribution on the residuals of $\\epsilon_{ij} \\sim N( 0, \\sigma^2 )$.\nLevel 2 is the second equation with a distribution of random effects of $$u_{j} \\sim N( 0, \\sigma^2_\\alpha ) .$$ The $\\sigma^2_\\alpha$ is the variance of the random intercept.\n\nCall the $\\beta_{0j}$ the random intercept and $u_{j}$ the random effect.\nThe $u_{j}$ is the residual of the level 2 model,.\nIn R, we would say `coef()` for the intercept (including the mean $\\gamma_0$) and `ranef()` for the random effect.\nIn math, `coef()` gives $\\gamma_0 + u_j$ and `ranef()` gives only $u_j$.\nNeither include the $\\gamma_1$ or $\\gamma_2$; these will be separate columns you get from `coef()`.\n\n##### Remarks.\n\nWe have *completely pooled* the coefficient for $R_{ij}$ and $X_{ij}$: we are assuming all the schools have the same relationship between the outcome and these covariates.\n\nThe intercept $\\alpha_{j}$ is the expected (predicted average) outcome of a not-at-risk student with $X_{ij} = 0$.\nDifferent schools have different means.\nIn particular, treatment schools have a mean of $\\gamma_1$ more than control; this is the treatment impact.\n\n### The Reduced Form Model\n\nIf we plug in our 2nd level into the first we get the following: $$\\begin{aligned}\nY_{ij} &= \\beta_{0j} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n&= (\\gamma_{0} + \\gamma_{1} Z_{j} + \\gamma_{2} S_{j} + u_{j}) + \\beta_1 R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n&= \\gamma_{0} + \\gamma_{1} Z_{j} + \\gamma_{2} S_{j} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + (u_{j} + \\epsilon_{ij})\n\\end{aligned}$$ The $u_{0j} + \\epsilon_{ij}$ is our total random error.\nIt is how much our prediction of a new, unknown student, would differ from their actual score if we didn't know the school's random effect.\nThe rest of the model is the mean model or structural portion of the model.\n\nThis is also called the *reduced form*; it is what econometricians work with.\nThey will write the entire residual as $\\varepsilon_{ij}$, however: $$\\begin{aligned}\nY_{ij} &= \\gamma_{0} + \\gamma_{1} Z_{j} + \\gamma_{2} S_{j} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + \\varepsilon_{ij}\n\\end{aligned}$$\n\n##### Remarks.\n\nThe reduced form helps us see our treatment effect more clearly.\nIt is a shift in outcome of $\\gamma_1$ for treated students.\n\nThe $\\gamma_{0}$ is the overall mean reading level for students with $X_{ij}=0$ for not-at-risk students ($R_{ij}=0$) in control schools with $S_j = 0$.\n\nNote how we subscript school-level covariates with only a $j$ vs. individual-level covariates get an $ij$.\nIf you want, you can index everything by $ij$; the fact that $S_{ij}$ will then be the same for all students $i$ in school $j$ is hidden in the data.\nBut it does make it look very much like OLS with a weird error term: $$\nY_{ij} = \\gamma_{0} + \\gamma_{1} Z_{ij} + \\gamma_{2} S_{ij} + \\beta_{1} R_{ij} + \\beta_{2} X_{ij} + (u_{j} + \\epsilon_{ij})\n$$\n\nFinally, you might call all the different pieces by different letters to indicate whether you care about them or not.\nE.g., $$Y_{ij} = \\mu + \\tau Z_{ij}  + \\beta_1 S_{ij} + \\beta_2 R_{ij} + \\beta_3 X_{ij} + (u_{0j} +  \\epsilon_{ij}) .$$ Here $\\tau$ is our treatment effects of interest.\nThe $\\beta$'s are just adjustments to be ignored.\nThe $\\mu$ is the grand mean (for those not treated, with $S_{ij} = 0$ and $R_{ij} = 0$ and $X_{ij} = 0$).\nPeople often use $\\mu$ for mean and $\\tau$ for treatment.\n\n### Fitting it in lmer\n\nWe fit it as:\n\n```         \n    lmer( Y ~ R + Z + X + S + (1|id), data=dat )\n```\n\n## The Two-Level Random Slopes Model\n\nNow let's get very complex to really unpack notational stuff.\nWe are going to let treatment not only impact the average outcome in schools, but also allow treatment to differentially impact students who are \"at risk\".\nI.e., we are going to have two treatment impacts, one for not at risk, and one for at risk.\nThis is an interaction of risk status and treatment.\n\nFurthermore, we are going to let different schools have different gaps between at risk and not at risk, but allowing a random effect for the at risk coefficient.\n\nUsing our same variables as above, we have, for student $i$ in school $j$ $$\\begin{aligned}\nY_{ij} &= \\beta_{0j} + \\beta_{1j} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n\\beta_{0j} &= \\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + u_{0j} \\\\\n\\beta_{1j} &= \\gamma_{10} + \\gamma_{11} Z_{j} + u_{1j} .\n\\end{aligned}$$\n\nThis is the two-level model.\nLevel 1 is the first equation with the distribution on the residuals of $\\epsilon_{ij} \\sim N( 0, \\sigma^2 )$.\nLevel 2 are the second and third equations, and the distribution of random effects of $$\n\\begin{pmatrix} u_{0j} \\\\\nu_{1j}\n\\end{pmatrix} \\sim  N\n\\begin{bmatrix}\n\\begin{pmatrix}\n0 \\\\\n0\n\\end{pmatrix}\\!\\!,&\n\\begin{pmatrix}\n\\tau_{00} & \\tau_{10} \\\\\n\\tau_{10} & \\tau_{11} \\\\\n\\end{pmatrix}\n\\end{bmatrix}\n$$ The $\\tau_{00}$ is the variance of the random intercept.\n$\\tau_{11}$ is the variance of the random slope.\n$\\tau_{10}$ is the covariance (not correlation) of the random effects.\nTo get the *correlation* of random effects we have $\\rho = \\tau_{10} / \\sqrt{ \\tau_{00} } \\sqrt{ \\tau_{11} }$.\n(Note that $\\tau_{10} = \\tau_{01}$, meaning the covariance of A and B is the same as covariance of B and A, so we just write one of them.)\n\nCall the $\\beta_{0j}$ the random intercept and $\\beta_{1j}$ a random coefficient.\nWe might call them both random coefficients.\nCall the $u_{0j}, u_{1j}$, which are the residuals of the level 2 models, the random effects.\nIn R, we would say `coef()` for the coefficients (including the means) and `ranef()` for the random effects.\n\n### Remarks.\n\nWe have *completely pooled* the coefficient for $X_{ij}$: we are assuming all the schools have the same relationship between the outcome and $X_{ij}$.\nThis is why we have no level 2 equation for $\\beta_{2}$ and we do not index $\\beta_2$ as $\\beta_{2j}$.\n\nThe intercept $\\beta_{0j}$ is the expected (predicted average) outcome of a not-at-risk student with $X_{ij} = 0$.\nDifferent schools have different means.\n\nThe achievement gap of at-risk and not-at-risk students for control schools is measured by $\\gamma_{10}$.\nFor treatment schools it is $\\gamma_{10} + \\gamma_{11}$.\n\nThe $\\gamma_{01}$ is the average treatment effect for not-at-risk students.\nThen $\\gamma_{01} + \\gamma_{11}$ is the average treatment effect for the at-risk students.\nIf we find $\\gamma_{11} \\neq 0$ then the average effects differ for our two types of students, and the change in the achievement gap induced by treatment is measured by $\\gamma_{11}$.\n\nIn this model, the school-level covariate explains overall differences in reading between schools, but does not relate to the size of treatment impact in a school, or relate to the at-risk vs. not-at-risk achievement gap.\n\n### The level 2 covariate matrix.\n\nSometimes people like to write the correlation matrix using other parameterizations.\nE.g., we might see $$\n\\begin{pmatrix} u_{0j} \\\\\nu_{1j}\n\\end{pmatrix} \\sim  N\n\\begin{bmatrix}\n\\begin{pmatrix}\n0 \\\\\n0\n\\end{pmatrix}\\!\\!,&\n\\begin{pmatrix}\n\\sigma^2_\\alpha & \\rho \\sigma_\\alpha \\sigma_R \\\\\n & \\sigma^2_R \\\\\n\\end{pmatrix}\n\\end{bmatrix}\n$$ to indicate the cross-school variation in the intercept ($\\alpha$) and the risk gap ($R$).\nNow we specifically have written our correlation of random effects as $\\rho$.\n\n### The Reduced Form Model\n\nIf we plug in our 2nd level into the first we have to plug in both equations.\nIf we do we get\\...\na mess: $$\\begin{aligned}\nY_{ij} &= \\beta_{0j} + \\beta_{1j} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n&= (\\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + u_{0j}) + (\\gamma_{10} + \\gamma_{11} Z_{j} + u_{1j}) R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\\n&= \\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + u_{0j} + \\gamma_{10} R_{ij} + \\gamma_{11} Z_{j} R_{ij} + u_{1j} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} \\\\ \n&= \\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + \\gamma_{10} R_{ij} + \\gamma_{11} Z_{j} R_{ij} + \\beta_{2} X_{ij} + u_{0j} +  u_{1j} R_{ij} + \\epsilon_{ij} \\\\\n&= \\gamma_{00} + (\\gamma_{01} + \\gamma_{11} R_{ij} ) Z_{j}  + \\gamma_{02} S_{j} + \\gamma_{10} R_{ij} + \\beta_{2} X_{ij} + (u_{0j} +  u_{1j} R_{ij} + \\epsilon_{ij}) \\\\\n\\end{aligned}$$ The $u_{0j} + u_{1j} R_{ij} + \\epsilon_{ij}$ is our total random error.\nIt is how much our prediction of a new, unknown student, would differ from their actual score if we didn't know the school's random effect.\nThe rest of the model is the mean model or structural portion of the model.\n\nThis is our *reduced form*; it is what econometricians work with.\nThey will write the entire residual as $\\varepsilon_{ij}$, however: $$\\begin{aligned}\nY_{ij} &= \\gamma_{00} + (\\gamma_{01} + \\gamma_{11} R_{ij} ) Z_{j}  + \\gamma_{02} S_{j} + \\gamma_{10} R_{ij} + \\beta_{2} X_{ij} + \\varepsilon_{ij} \\\\\n\\end{aligned}$$\n\n##### Remarks.\n\nThe reduced form helps us see our treatment effects and treatment variation across groups more clearly.\nWe can put both terms involving the treatment indicator in parenthesis (final line above) to show how treatment is different by $\\gamma_{11}$ for the at-risk students.\n\nWe also see that the difference in treatment effects between at-risk and not at-risk is an *interaction* between student risk and treatment assignment of the school (note the $Z_j R_{ij}$ term).\n\nThe $\\gamma_{00}$ is the overall mean reading level for students with $X_{ij}=0$ for not-at-risk students in control schools.\nThe $\\gamma_{10}$ is the average difference between at-risk and not-at-risk students in control schools, across all schools.\n\nWe can rearrange our equations above to get $$Y_{ij} = ( \\gamma_{00} + u_{0j}) + (\\gamma_{01} + \\gamma_{11} R_{ij} + u_{1j} ) Z_{j} + \\gamma_{02} S_{j} + \\gamma_{10} R_{ij} + \\beta_{2} X_{ij} + \\epsilon_{ij} .$$ This shows the random intercept and random slope all bundled up.\n\nAs with the intercept model, you might call all the different pieces by different letters to indicate whether you care about them or not.\nE.g., $$Y_{ij} = \\mu + \\tau Z_{ij}  + \\beta_1 S_{ij} + \\beta_2 R_{ij} + \\beta_3 X_{ij} + \\tau_{R} Z_{ij} R_{ij}  + (u_{0j} +  u_{1j} R_{ij} + \\epsilon_{ij}) .$$ Here $\\tau$ and $\\tau_R$ are our treatment effects of interest.\nThe $\\beta$'s are just adjustments to be ignored.\nThe $\\mu$ is the grand mean.\nThis model is the same as above, we are just changing names around.\n\n### Fitting it in lmer\n\nWe fit it as:\n\n```         \n    lmer( Y ~ R * Z + X + S + (R|id), data=dat )\n```\n\nTwo other ways of saying the same thing:\n\n```         \n    lmer( Y ~ 1 + R * Z + X + S + (1 + R|id), data=dat )\n```\n\nand\n\n```         \n    lmer( Y ~ 1 + Z + S + R + Z:R + X + (1 + R|id), data=dat )\n```\n\n### Remarks.\n\nSee how the reduced form and `lmer()` align, especially if we write out what R automatically does with `R * Z` (R will expand `R*Z` into `R + Z + R:Z` automatically).\n\n### Another form for the two-level model\n\nThe above is the \"double-subscript\" way of writing a model.\nBy contrast, Gelman and Hill index with a nifty \"bracket notation.\" First, let $j[i]$ indicate the school student $i$ is attending.\nThen we have: $$\\begin{aligned}\nY_{i} &= \\beta_{0j[i]} + \\beta_{1j[i]} R_{i} + \\beta_{2} X_{i} + \\epsilon_{i} \\\\\n\\beta_{0j} &= \\gamma_{00} + \\gamma_{01} Z_{j} + \\gamma_{02} S_{j} + u_{0j} \\\\\n\\beta_{1j} &= \\gamma_{10} + \\gamma_{11} Z_{j} + u_{1j},\n\\end{aligned}$$ This is basically identical to the above, but if you are not familiar with the bracketing then things can get messy.\n\nThe advantage of this is we can then imagine each student gets their own unique id, $i$, and then we can query where that student is via $j[i]$.\nThis can be useful when looking at crossed effects models, where units have different random effects for different things (e.g., for a test we might have observation $k$ corresponding to a single answer for a test question, with $i[k]$ being the student who answered it and $q[k]$ being the question item).\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","highlight-style":"pygments","output-file":"model_representations.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.4.553","bibliography":["references.bib"],"output_dir":"docs","editor":{"markdown":{"wrap":"sentence"}},"theme":"cosmo","code-copy":true,"title":"Model Representations","author":"Luke Miratrix"},"extensions":{"book":{"multiFile":true}}},"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"xelatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","highlight-style":"pygments","output-file":"model_representations.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words"},"metadata":{"block-headings":true,"bibliography":["references.bib"],"output_dir":"docs","editor":{"markdown":{"wrap":"sentence"}},"documentclass":"scrreprt","title":"Model Representations","author":"Luke Miratrix"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html","pdf"]}